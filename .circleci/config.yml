---
version: 2.1

orbs:
  python: tinyclues/python@3.5.8

executors:
  python:
    docker:
      - image: circleci/python:3.7

aliases:
  all_branches_and_tags: &all_branches_and_tags
    filters:
      tags:
        only: /.*/
      branches:
        only: /.*/

workflows:
  build:
    jobs:
      - python/run_in_pipenv_env:
          name: cython_setup
          pipenv_env_type: dev
          executor: python
          persist_directory: cyperf
          command: setup.py build_ext -i -j2
          <<: *all_branches_and_tags
      - python/run_in_pipenv_env:
          name: run_lint
          pipenv_env_type: dev
          executor: python
          requires:
            - cython_setup
          command: pylint labeledmatrix cyperf --rcfile=setup.cfg
          <<: *all_branches_and_tags
      - python/run_in_pipenv_env:
          name: unit_tests
          pipenv_env_type: dev
          executor: python
          requires:
            - cython_setup
          command: pipenv run pytest tests --durations=10
          <<: *all_branches_and_tags

      - python/pipenv_deploy:  # TODO do we need sdist in setup.py command ?
          name: deploy_wheel
          requires:
            - unit_tests
          context: artifactory
          executor: python
          <<: *all_branches_and_tags
